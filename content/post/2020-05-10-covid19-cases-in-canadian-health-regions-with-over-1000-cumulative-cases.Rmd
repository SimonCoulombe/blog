---
title: "Local Covid19 cases:   Canadian health regions and Montreal boroughs"
author: simon
date: '2020-05-10'
slug: covid19-cases-in-canadian-health-regions-with-over-1000-cumulative-cases
categories:
  - r
  - covic19
tags: []
keywords:
  - tech
thumbnailImage: "/post/2020-05-10-covid19-cases-in-canadian-health-regions-with-over-1000-cumulative-cases_files/montreal20200512.png" 
thumbnailImagePosition: left      
---
blo
```{r setup, include =F, echo =F}
#
# TODO : valider ceci : Chunk options must be written in one line; no line breaks are allowed inside chunk options;
# https://yihui.name/knitr/options/
knitr::opts_chunk$set(echo = FALSE, 
                      collapse = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      fig.align= "center",
                      fig.width = 12,
                      fig.height = 10,
                      highlight = TRUE,
                      cache = FALSE,
                      cache.lazy = FALSE) # fixes long vecto rnot supported quand on cache des gros éléments https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-error-in-rmd-but-not-in-r-script
```


Quick post inspired by the winning / nearly there / need action graphs by @yaneerbaryam at https://www.endcoronavirus.org/countries.

# Data  

Health regions date is compiled by Isha Berry & friends [github](https://github.com/ishaberry/Covid19Canada).
Montreal boroughs data is [published daily](https://santemontreal.qc.ca/population/coronavirus-covid-19/).  They only keep the total and keep no history, so @bouchecl visits them every day and compiles the data in this [google sheet](https://docs.google.com/spreadsheets/d/1mOyyeCHwfI_F_T3pAalIdMBxhhfTbM7m5RvbciXIvPM/)  

# Code   

As usual, the code [for this post is on github](https://github.com/SimonCoulombe/snippets/blob/master/content/post/2020-05-10-covid19-cases-in-canadian-health-regions-with-over-1000-cumulative-cases.Rmd).  

New to me : the new tidyeval that uses {{ }}, and using vars() inside facet_wrap to allow tidyevaluation.


```{r}
library(tidyverse)
library(googlesheets4)
# mortality_hr <- read_csv("htt ps://raw.githubusercontent.com/ishaberry/Covid19Canada/master/timeseries_hr/mortality_timeseries_hr.csv") %>%
#   rename(cases = deaths,
#          cumulative_cases = cumulative_deaths,
#          date_report = date_death_report,
#   )


cases_timeseries_hr <- read_csv("https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/timeseries_hr/cases_timeseries_hr.csv") %>%
  mutate(date_report = lubridate::dmy(date_report))%>%
  filter(health_region != "Not Reported") %>%
  mutate(health_region = case_when(
    health_region == "Gaspésie-Îles-de-la-Madeleine" ~ "Gaspésie", 
    health_region == "Abitibi-Témiscamingue" ~ "Abitibi",
    health_region == "Terres-Cries-de-la-Baie-James" ~ "Terre-Cries",
    TRUE ~ health_region)
  )  %>%
  mutate(pr_region = paste0(province,"-", health_region)  )
```



```{r}
prep_data <- function(data, group){
  gaa <-   data %>% 
    group_by( {{ group }} ) %>%
    arrange(date_report) %>% 
    mutate(avg_cases_last7 = (cases + lag(cases, 1) + lag(cases, 2) + lag(cases, 3) + lag(cases, 4) + lag(cases, 5) + lag(cases, 6)) / 7)  %>%
    ungroup() 
  
  
  gaa1 <- gaa %>%
    group_by( {{ group }}) %>%
    summarise(total = sum(cases),
              worst7 = max(avg_cases_last7, na.rm = TRUE),
              last7  = max(avg_cases_last7 * (date_report == max(date_report)), na.rm = TRUE),
              ratio = last7 / worst7,
              winning = factor( 
                case_when(ratio < 0.33 ~ "Winning",
                          ratio < 0.67 ~ "Nearly there",
                          TRUE ~ "Needs action"
                )
                , levels = c("Winning", "Nearly there", "Needs action"))
    ) %>%
    ungroup() %>%
    
  mutate(
  group = fct_reorder( {{ group }}, total, .desc =TRUE)
  )



gaa %>% 
  left_join(gaa1) 

}


# https://www.tidyverse.org/blog/2019/06/rlang-0-4-0/
# {{ }}

# https://edwinth.github.io/blog/dplyr-recipes/
# filter_func <- function(x, filter_exp) {
#   filter_exp_enq <- enquo(filter_exp)
#   x %>% filter(!!filter_exp_enq)
# }
# filter_func(mtcars, hp == 93)
create_graph <- function(data, filter_exp, title, geo,mindate= "20200315"){
  #browser()
  labels <- data %>% 
    filter( {{ filter_exp }} ) %>% 
    group_by( {{ geo }} )%>%
    summarise(label = paste0( format(sum(cases), 
                                     digits=9,
                                     decimal.mark=",", 
                                     big.mark=" ",
                                     small.mark=".", 
                                     small.interval=3), 
                              " cases"),
              value =  0.9 *  max(avg_cases_last7, na.rm = TRUE)
    
    ) %>%
    mutate(key="avg_cases_last7",
           date_report = lubridate::ymd(mindate)+1
    )
  
  data  %>%
    filter( {{ filter_exp }}  & date_report >= lubridate::ymd(mindate)) %>%
    gather(key=key, value= value,  avg_cases_last7) %>% #cases,
    mutate(alpha = if_else(key == "cases", 0.5, 1)) %>%
    ggplot(aes(x=date_report, y= value, group = key))+
    facet_wrap( vars ({{ geo }})  , scales = "free" )+
    geom_line(aes( color = winning, alpha = key), size =1) + # linetype = key,
    dviz.supp::theme_dviz_grid()+
    scale_y_continuous(breaks = scales::pretty_breaks(n =5) )+
    theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
      scale_colour_manual(values = c("darkgreen", "darkorange", "darkred"), name = "(# of cases last week) / (# of cases worst week):",  labels= c("< 0.33", "0.33 to 0.67", " > 0.67"))  + # ,guide = "none"
    scale_alpha_manual(values = c(1, 0.3), labels= c("7-day average", "Daily count"),name =  "type:" ) + #  name = NULL , guide = "none"
    labs(
      title = title,
      subtitle = paste0("As of ", format(lastdate, format="%B %d %Y")),
      caption = "Graph by @coulsim, data by @ishaberry2 https://github.com/ishaberry/Covid19Canada"
    ) +
    xlab("date")+
    ylab ("Daily new cases") +
    theme(legend.position="bottom") +
    geom_text(data= labels ,
              aes(label = label),
              hjust = "left" )
}



get_province_graph <- function(.prov){
  
  z <- cases %>% 
    filter(province == .prov) %>%
    mutate(health_region = fct_reorder(health_region, total, .desc =TRUE))

  create_graph(z,
             TRUE,
             paste0("Daily new Covid-19 cases by health regions in ", .prov),
             health_region)
}
```



# Canada - health regions with over 1000 cumulative cases

```{r canada }

cases <- prep_data(cases_timeseries_hr, pr_region)  
  
#deaths <- prep_datpretty_ba(mortality_hr)

lastdate  <- max(cases$date_report)

create_graph(cases, 
             total > 1000 , 
             "Daily new Covid-19 cases in health regions with cumulative cases over 1000",
             group)

```


# Provinces (all health regions)  

```{r qc}

map(unique(cases$province), ~get_province_graph(.prov = .x))
```

# Montréal boroughs  

données arrondissement montréal
```{r}
url_mtl_arrondissement <- "https://docs.google.com/spreadsheets/d/1mOyyeCHwfI_F_T3pAalIdMBxhhfTbM7m5RvbciXIvPM/"
gs4_deauth()
prout <- read_sheet(url_mtl_arrondissement)

mtl  <- prout[1:which(prout$Quartier == "Westmount"), ] %>% 
  gather(key=key, value=cumulative_cases, -Quartier) %>%
  mutate(cumulative_cases = map_int(cumulative_cases, ~ as.integer(str_replace_all(.x, " ", "")))) %>% # remove spaces from numbers
  mutate(date_report = lubridate::dmy(paste0(str_replace_all(str_replace_all(str_replace_all(key," mars","03"), " avr.", "04"), " mai", "05"), 2020))) %>%
  select(-key) %>%
  group_by(Quartier) %>% 
  arrange(Quartier, desc(date_report)) %>% ## descending date to fix cumulative 
  mutate(cumulative_cases = if_else(cumulative_cases > lag(cumulative_cases), lag(cumulative_cases), cumulative_cases, cumulative_cases)) %>% ## cumulative can't be bigger than next day.. if so reduce to next day level.
  arrange(Quartier, date_report) %>% ## ascending date
  mutate(cases = cumulative_cases - lag(cumulative_cases)) %>% 
  ungroup() %>%
  filter(!is.na(cases)) 


mtl_cases <- prep_data(mtl, Quartier)
lastdate  <- max(mtl_cases$date_report)
create_graph(mtl_cases , 
             total> 200,
             "Daily new Covid-19 cases for Montreal boroughs with more than 200 cases", 
             group,
             mindate="20200405") +
  labs(caption = "graph by @coulsim, data compiled by @bouchecl from https://santemontreal.qc.ca/population/coronavirus-covid-19/ ")


```


```{r montreal}
create_graph(mtl_cases , 
             total <= 200,
             "Daily new Covid-19 cases for Montreal boroughs with less than 200 cases", 
             group,
             mindate="20200405") +
  labs(caption = "graph by @coulsim, data compiled by @bouchecl from https://santemontreal.qc.ca/population/coronavirus-covid-19/")


```

