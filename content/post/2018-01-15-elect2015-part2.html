---
title: "Federal elections results by poll section part 2 :  map census data to poll section and plot the results"
author: "Simon Coulombe"
date: 2018-01-14
slug: "election_part2"
output:
  blogdown::html_page:
    toc: true
categories: ["R"]
tags: ["sf", "open data", "rstats"]
---


<div id="TOC">
<ul>
<li><a href="#code">Code</a></li>
<li><a href="#functions">Functions</a></li>
<li><a href="#code-snippets-i-will-be-coming-back-to-this-script-for">Code snippets I will be coming back to this script for</a></li>
<li><a href="#getting-the-census-data-and-applying-it-to-the-poll-sections">Getting the census data and applying it to the poll sections</a></li>
<li><a href="#results">Results</a></li>
</ul>
</div>

<p>This Notebook builds on the <code>poll_final</code> sf dataframe we built in the <a href="https://www.simoncoulombe.com/2018/01/election_part1/">first part of this project</a>. <code>poll_final</code> contains the poll results by party and the geometry for each poll for the 2015 Federal Elections of 2015.</p>
<p>We will use the <code>cancensus</code> package to download sociodemographic data and geometry from the 2016 Canadian Census. We will then “dispatch” the population characteristics to each poll sections and plot the relationship between education and the results of the three main parties (libéral, conservateur and ndp).</p>
<p>This notebook uses the <code>tidyverse</code> for wranling and plotting data, the <code>cancensus</code> package to download the Canadian Census data, the <code>lwgeom</code> package for making polygons “valid” and the `sf package for finding their intersections.</p>
<p>Disclaimer: I am not a poticial science expert, I just like messing around with data when my kids wake me up at night. The results here may be common knowledge already, my assumptions may be extremely wrong and my code could just be bugged.</p>
<div id="code" class="section level1">
<h1>Code</h1>
<p>As usual, the code for this post is available on my <a href="https://github.com/SimonCoulombe/snippets">GitHub repo</a> and is then hosted on my Hugo <a href="http://www.simoncoulombe.com">blog</a> generated by blogdown and hosted on github/netlify.</p>
</div>
<div id="functions" class="section level1">
<h1>Functions</h1>
<p>I created three functions that wrap around the <code>cancensus</code> package:</p>
<p><code>get_cancensus_pct</code> takes a parent vector and a generation level (first or last) for the children vectors and return a dataframe showing the percentage each child vectors represents at the geographic level specified.<br />
<code>get_cancensus_labels</code> takes a parent vector and a generation level (first or last) for the children vectors and return the labels for the parent and children vectors.<br />
<code>get_cancensus_data</code> build on these two functions. It takes a vector of parent vectors names and a generation level and returns a list of three objectS:</p>
<ul>
<li>a dataframe with the percentages</li>
<li>a dictionnary showing which child are contained in each parent vector</li>
<li>a list of the parent vectors.</li>
</ul>
<p>Finally, the <code>wrapper</code> function automatically adds line changes to strings after a certain length, allowing titles to fit inside ggplot. I borrowed it from the internet a while ago.</p>
</div>
<div id="code-snippets-i-will-be-coming-back-to-this-script-for" class="section level1">
<h1>Code snippets I will be coming back to this script for</h1>
<ul>
<li>My three cancensus functions.<br />
</li>
<li>example of st_make_valid() and st_intersection()</li>
<li>combining purrr and ggplot using map2(data,..)<br />
</li>
<li>usethis::edit_r_profile() , then add the following for cancensus:
<ul>
<li>options(cancensus.api_key = Sys.getenv(“cancensus_api”))<br />
</li>
<li>options(cancensus.cache_path = ‘C:/MY_CACHE_PATH’)</li>
</ul></li>
</ul>
</div>
<div id="getting-the-census-data-and-applying-it-to-the-poll-sections" class="section level1">
<h1>Getting the census data and applying it to the poll sections</h1>
<p>Getting the census data and shapefile is pretty straightforward when done using the <code>cancensus</code> package. “v_CA16_5051” is the highest level of schooling.</p>
<p>We download the census data at the Dissemination Area (DA) level, which is the smallest geographical level for which Statistics Canada will release data. Its population is between 400-700 persons.</p>
<p>Once we have the DA data, we find the intersection between the DA and the poll sections.<br />
Lines that should be identical in both files are not always 100% accurate, which leads to small intersection between polygons that should not intersect. To prevent this, I ignore intersections that represent less than 10% of either the DA or poll polygon.</p>
<p>We then distribute the DA population to the polls. We make three important assumptions:</p>
<ul>
<li>elector population is proportional to total populattion (we should use population aged 18+ at the very least)<br />
</li>
<li>DA population is uniformly distributed on the whole area<br />
</li>
<li>Participation rate is equal among all DA that touch a poll</li>
</ul>
<p>To make analysis easier, we group the highest levels of schooling in three groups:</p>
<ul>
<li>No high school diploma<br />
</li>
<li>High school, college, trade or university certificate below bachelor<br />
</li>
<li>University (bachelor degree or above)</li>
</ul>
</div>
<div id="results" class="section level1">
<h1>Results</h1>
<p>Finally, we make scatter plots showing the relationship between the level of schooling of the poll and the results of the three main parties. Each dot represents one polling station. I have broken down the poll between the 10 provinces and the 3 territories to see if the trends hold between different areas.</p>
<p>Province codes:</p>
<ul>
<li>10 Newfoundland and Labrador<br />
</li>
<li>11 Prince Edward Island<br />
</li>
<li>12 Nova Scotia<br />
</li>
<li>13 New Brunswick<br />
</li>
<li>24 Quebec<br />
</li>
<li>35 Ontario<br />
</li>
<li>46 Manitoba<br />
</li>
<li>47 Saskatchewan<br />
</li>
<li>48 Alberta<br />
</li>
<li>59 British Columbia<br />
</li>
<li>60 Yukon<br />
</li>
<li>61 Northwest Territories<br />
</li>
<li>62 Nunavut</li>
</ul>
<p>Results are not uniform across provinces, but I spotted the following trends outside of the Atlantic provinces (NFL, PEI, NS and NB).</p>
<p>A high share of population with no high school will help the NPD in most provinces outside of the Atlantic.</p>
<p><img src="/post/2018-01-15-elect2015-part2_files/figure-html/plot_nohs-1.png" width="1344" style="display: block; margin: auto;" /></p>
<p>The conservative party appears to thrive in poll sections with a high proportion of “middle level” education such as high school or college degrees, trade certificates outside of the Atlantic.</p>
<p><img src="/post/2018-01-15-elect2015-part2_files/figure-html/plot_hsplus-1.png" width="1344" style="display: block; margin: auto;" /></p>
<p>A high share of university degrees typically helps the Libéral, except in the Atlantic, where it will favour the NPD. It never helps the conservative party.</p>
<p><img src="/post/2018-01-15-elect2015-part2_files/figure-html/plot_uni-1.png" width="1344" style="display: block; margin: auto;" /></p>
</div>
