---
title: Please make the sun rise
author: Simon
date: '2019-11-05'
slug: sunrise_timezone
categories: []
tags: []
keywords:
  - tech
---

<!--more-->


```{r}
install.packages("suncalc")
library(tidyverse)
library(suncalc)
library(lubridate)
library(sf)
library(mapview)
getSunlightTimes(date=  ymd("20191105"), lat = 46.7382, lon = -71.2465)
library(ggmap)



# timezone shapefile
# https://stackoverflow.com/questions/23414340/convert-to-local-time-zone-using-latitude-and-longitude

download.file("https://github.com/evansiroky/timezone-boundary-builder/releases/download/2018d/timezones.geojson.zip",
              destfile = "timezones.geojson.zip")
utils::unzip("timezones.geojson.zip")
tzs = st_read("dist/combined.json", quiet = TRUE)
mapview(tzs)
# province shapefile?
download.file("http://www12.statcan.gc.ca/census-recensement/2011/geo/bound-limit/files-fichiers/2016/lpr_000b16a_e.zip", 
              destfile = "lpr_000b16a_e.zip")
utils::unzip("lpr_000b16a_e.zip")
)
z <- read_sf("lpr_000b16a_e.shp",  
             options = "ENCODING=windows-1252") 
zz <- z %>% 
  sf::st_transform(crs = 4326) %>%
  rmapshaper::ms_simplify(.)  
  
mapview(zz)
zz  %>% filter(as.numeric(PRUID) <= 59) %>% mapview

bb <- st_bbox(zz)
lon <- seq(from= bb$xmin, to = bb$xmax, by= 1)
lat<- seq(from= bb$ymin, to = bb$ymax, by= 1)
data <-  crossing(lon,lat) %>% 
  mutate(date = ymd("20191105"))


prout <- getSunlightTimes(data = data) %>%
  as_tibble()
# get timezone avec st_join https://stackoverflow.com/questions/23414340/convert-to-local-time-zone-using-latitude-and-longitude
prout2 <- st_as_sf(prout, coords = c("lon", "lat"), crs = 4326)
prout3 <- st_join(prout2, tzs)       %>%
  filter(!is.na(tzid)) %>%
  mutate(tzid = as.character(tzid))
prout4 <- prout3 %>%
  mutate(zzz = map2 (sunrise, tzid, ~ with_tz(.x, .y)) )

prout %>% mutate( time = hour(sunrise)) %>% glimpse


provs <- zz  %>% filter(as.numeric(PRUID) <= 59)
clines <- geom_polygon(aes(lon, lat),
                       fill = NA, col = "lightgray", data = provs)

p <- ggplot() + clines
p

ggplot(provs)+
  geom_sf() + 
  geom_contour(data = prout, aes(x= lon, y= lat, z = as.numeric(sunrise)), na.rm = TRUE)
  
ggplot(data= prout, 
       aes(x= lon,
           y =lat,
           ))

```

